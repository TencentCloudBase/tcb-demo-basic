/*!
 * @cloudbase/weda-cloud-sdk
 * Copyright© 2024 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx"),{},{},{},{},require("@cloudbase/oauth")):"function"==typeof define&&define.amd?define(["exports","mobx","@cloudbase/js-sdk/app","@cloudbase/js-sdk/auth","@cloudbase/js-sdk/functions","@cloudbase/js-sdk/storage","@cloudbase/oauth"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.mobx,e.cloudbase,e.tcbauth,e.tcbfunctions,e.tcbstorage,e.tcboauth)}(this,(function(e,t,n,r,o,i,s){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=a(n);function u(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function l(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function d(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n}class f extends Error{constructor(e,t,n){super(t),this.code=e,this.name="TCBError",this.original=n}}function p(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}const h={};let g;function m(e){if(!g)throw new Error("app config not inited");return e?g[e]:g}function v(){}function y(e){g=Object.assign(g||{},e)}function w(e){return!e&&g.useLegacyDatasource?"lcap-common-service":"lowcode-datasource"+(g.isProd?"":"-preview")}function S(e,t){return e.length===t.length&&e.every(((e,n)=>e===t[n]))}const O=[];function I(e,...t){const n=O.find((n=>n[0]===e&&S(n[1],t)));if(n)return n[2];const r=e(...t);return O.push([e,t,r]),r}function x(e,t){if(!e)return e;return t.reduce(((t,n)=>(p(e,n)&&(t[n]=e[n]),t)),{})}const b={};function T(e,t){b[e]=t}function _(e,t){const n=b[e];return n&&"function"==typeof n?n(t):n}function A(){return"tcb-api"===m("endpointType")}function P(e){const t=e=>({status:"fulfilled",value:e}),n=e=>({status:"rejected",reason:e});return Promise.all(e.map((e=>Promise.resolve(e).then(t,n))))}function D(e){return"string"==typeof e}function k(e){return"[object Object]"===Object.prototype.toString.call(e)}const E=e=>{const t=t=>{for(const n in e)e.hasOwnProperty(n)&&(t[n]=E(e[n]));return t},n=null==e?"NullOrUndefined":Object.prototype.toString.call(e).slice(8,-1);if(["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"].includes(n))return e.slice();switch(n){case"Object":return t(Object.create(Object.getPrototypeOf(e)));case"Array":return t([]);case"Date":return new Date(e.valueOf());case"RegExp":return new RegExp(e.source,`${e.global?"g":""}${e.ignoreCase?"i":""}${e.multiline?"m":""}${e.sticky?"y":""}${e.unicode?"u":""}`);default:return e}};function U(e){const t=m("datasetProfiles");return e?t[e]:t}class C{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return u(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return u(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return u(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}}const N=/^[^:]+:\/\/[^/]+(\/[^?#]+)/;function $(e){if(e)return function(t,n){var r;return u(this,void 0,void 0,(function*(){let o;const i=null===(r=null==n?void 0:n.headers)||void 0===r?void 0:r["x-request-id"];try{const r=Object.assign({},n);r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body)),o=yield e(Object.assign(Object.assign({},r),{url:t,method:r.method||"GET"})),o.code&&(o={error:o.code,error_description:o.message||o.code,request_id:o.requestId})}catch(e){o={error:"unreachable",error_description:e.message}}if(o.request_id||(o.request_id=i),o.error)throw o.error_uri=j(t),o;return o}))}}function j(e){return N.test(e)?RegExp.$1:e}function M(e,t){return u(this,void 0,void 0,(function*(){if(e.privatelink){let n;if(e.getPrivatelinkAdapter){const t=yield e.getPrivatelinkAdapter();t&&(n=t)}else try{n="undefined"!=typeof window?window.tcbAdapterPrivatelink:void 0}catch(e){}return(null==n?void 0:n.generateAdapterWithConfig)?n.generateAdapterWithConfig({__privatelink_config__:Object.assign({pathname:"/tcb_private_link"},e.privatelink),__tcbAPIEdnpointReg__:t?new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")):void 0}):void 0}}))}function L(e,t){const n=e.split(".");if(2!==n.length)return void console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e);let r=n[0];if("$page"===r){const e=m("currentPageId");if(!e||"$global"===e)return void console.warn("[weda-cloud-sdk]setStateVar: can not find currentPageId",r);r=e}const o=h[r],i=n[1];if(o&&(p(o.state.$status,i)||p(o.state,i))){if(o.state.$status[i]){if(t instanceof Error)return void(o.state.$status[i]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==o.state.$status[i].status&&(o.state.$status[i]={status:"success"})}o.state[i]=t}}const R={setState:L,setParams:function(e,t){const n=(m("datasetProfiles")||{})[e],r=h[e];if(!r||!n||!n.params)return;const o=x(t,Object.keys(n.params));r.params||(r.params={}),Object.entries(o).forEach((([e,t])=>{r.params[e]=t}))}},F={tempURLMaxWaitGap:50};function W(e){Object.assign(F,e)}function q(){return"undefined"!=typeof window&&window||"undefined"!=typeof globalThis&&globalThis}function z(){try{const e=q();if(!e)return;return"undefined"==typeof wx?q().location.href:e.__wxRoute}catch(e){}}function G(){const e=q();if(null==e?void 0:e.navigator)return e.navigator.userAgent;if("undefined"!=typeof wx&&wx.getSystemInfo){let e;return wx.getSystemInfo({success(t){t&&(e=["brand","model","version","system","platform","SDKVersion","language"].map((e=>`${e}: ${t[e]}`)).join(", "))}}),e}}!function(){try{if(W({userAgent:G()}),"undefined"!=typeof window&&window&&window.top){const e=window.__wconfig||top.location.search,t={};if(/\b__wedaTarget=([^&]+)/.test(e)){const e=decodeURIComponent(RegExp.$1);e&&(t.wedaTarget=e)}/\b__useLegacy=true\b/.test(e)&&(t.useLegacyDatasource=!0),y(t)}}catch(e){}}();const V="$CLOUD_SDK_VERSION$";function B(e,t){if("OPERATION_FAIL"===e.code||/OPERATION_FAIL/.test(e.message)){if(/FUNCTION_NOT_FOUND/.test(e.message)){const n=(null==t?void 0:t.FUNCTION_NOT_FOUND)||"找不到数据源的云函数";return new f("FUNCTION_NOT_FOUND",n,e)}if(/FUNCTIONS_EXECUTE_FAIL/.test(e.message)){const n=(null==t?void 0:t.FUNCTIONS_EXECUTE_FAIL)||"云函数执行失败";return new f("FUNCTIONS_EXECUTE_FAIL",n,e)}}if(/network request error/.test(e.message))return new f("NETWORK_ERROR","网络故障, 请检查本地网络连接是否正常",e);if(/method .* not found in datasource/i.test(e.message)){const n=(null==t?void 0:t.DS_METHOD_NOT_FOUND)||"找不到数据源的方法";return new f("DS_METHOD_NOT_FOUND",n,e)}return(null==t?void 0:t.DEFAULT_ERROR)?new f(e.code||"DEFAULT_ERROR",t.DEFAULT_ERROR,e):e}let K=new Map;const J=["wedaGetItem","wedaGetRecords","wedaGetItemV2","wedaGetRecordsV2","getApiKey"],H=["callWedaApi"];function X(){return u(this,void 0,void 0,(function*(){const e=m("initTcb"),{app:t}=yield e();return t}))}function Q(e){var t,n;return u(this,void 0,void 0,(function*(){const r="boolean"!=typeof e.parseBusinessInfo||e.parseBusinessInfo,o=Object.assign({},e),i=o.name||o.dataSourceName,{methodName:s}=o,a={params:o.params,methodName:s},c=(e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)})(null===(t=o.params)||void 0===t?void 0:t.swr);delete o.name,delete o.parseBusinessInfo,(null===(n=o.params)||void 0===n?void 0:n.swr)&&delete o.params.swr;const u=Object.assign(o.extraParams||{},{dataSourceName:i,methodName:s,defaultParams:_(i,a),params:o.params});try{const e=m("customCallDataSource");if(e){return yield e(Object.assign({},u,{parseBusinessInfo:r}))}const t=m("beforeDSRequest");t&&t(o);const n=yield Z({name:w(!0),data:u},{unwrapResult:!0,parseBusinessInfo:r,swr:c}),i=m("afterDSRequest");return i&&i(o,null,n),n}catch(e){if(console.warn(`[weda-cloud-sdk] failed to invoke datasource ${i}'s method ${s}`,e),r){const t=B(e,{FUNCTION_NOT_FOUND:`找不到数据源${i}的云函数`,DS_METHOD_NOT_FOUND:`数据源${i}中的方法${s}不存在或者未启用`,FUNCTIONS_EXECUTE_FAIL:`调用数据源${i}方法${s}失败: 请检查该数据源所有自定义方法的代码中是否存在语法错误`,DEFAULT_ERROR:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}),n=m("afterDSRequest");throw n&&n(o,t),t}return{code:e.errCode||-2,message:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}}}))}function Y(e,t){return new Proxy({},{get(n,r){if(t){const e=t(r);if(e)return e}return new Proxy({},{get:(t,n)=>(t,o)=>Q({name:r,methodName:n,extraParams:o,params:t,parseBusinessInfo:e})})}})}function Z(e,t){var n,r;return u(this,void 0,void 0,(function*(){let o=E(e);const i=m("initTcb"),s=m("isProd"),a={wedaAppId:m("appID"),userAgent:F.userAgent,referrer:z(),envType:s?"prod":"pre",wedaTarget:m("wedaTarget"),"x-cloud-sdk-version":V};o.data=Object.assign({},o.data,a);let c=null==t?void 0:t.app;if(!c){c=(yield i()).app}const l=m("beforeCallFunction");let d;l&&(o=yield l(o));const p=m("afterCallFunction");try{if(o=ne(o),(e=>{const{methodName:t}=(null==e?void 0:e.data)||{};J.includes(t)||H.includes(t)||(K=new Map)})(o),d=(null===(n=null==t?void 0:t.swr)||void 0===n?void 0:n.swrMode)?yield((e,t,n={},r)=>u(void 0,void 0,void 0,(function*(){const{cacheTime:o}=n||{},{methodName:i,dataSourceName:s,action:a}=e.data||{},c=o||2e4,u=r||`${i}_${s||a}`,l=JSON.stringify(e),d=K.get(u)||new Map;n.forceClear&&d.delete(l);const f=d.get(l)||{value:null,time:0,promise:null};return d.set(l,f),K.set(u,d),Date.now()-f.time>c&&!f.promise?f.promise=t(e).then((e=>{f.value=e,f.time=Date.now(),f.promise=null})).catch((e=>{f.value=e,f.time=Date.now()-c,f.promise=null})):f.promise||f.value,f.promise&&!f.value&&(yield f.promise),f.value})))(o,c.callFunction.bind(c),null==t?void 0:t.swr):yield c.callFunction(o),p&&p(o,null,JSON.parse(JSON.stringify(d))),(null===(r=null==t?void 0:t.swr)||void 0===r?void 0:r.swrMode)&&(null==d?void 0:d.error))throw d}catch(e){throw p&&p(o,e),e}if(null==t?void 0:t.unwrapResult){const{result:e}=d;if(!t.parseBusinessInfo)return e;if(!e.code)return e.data;throw console.warn("[weda-cloud-sdk]failed to invoke backend, %c调用后端接口失败, 请仔细查看下述错误信息:","color: red;"),console.warn(`\tcode: ${e.code}\n\tmessage: ${e.message}\n\treason: ${e.reason}\n\trequestId: ${d.requestId}\n\toriginal response: `,d),new f(e.code,e.message,d)}return d}))}const ee=["wedaGetRecords","wedaGetItem"],te=["wedaUpdateV2","wedaBatchUpdateV2","wedaGetItemV2","wedaGetRecordsV2","wedaDeleteV2","wedaBatchDeleteV2"],ne=e=>{try{const{methodName:t,params:n={}}=(null==e?void 0:e.data)||{};n.hasOwnProperty("where")&&ee.includes(t||"")&&(n.where=re(n.where)),n.hasOwnProperty("filter")&&te.includes(t||"")&&(n.filter=re(n.filter))}catch(e){}return e},re=e=>{let t;return Array.isArray(e)?(t=t||[],e.forEach((e=>{const n=re(e);void 0!==n&&t.push(n)})),t):k(e)?(Object.keys(e).forEach((n=>{const r=re(e[n]);void 0!==r&&(t=t||{},t[n]=r)})),t):e},oe=e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)};function ie(e,t){return u(this,void 0,void 0,(function*(){const n=E(e),r=E(n.swr||{});return delete n.swr,Z({name:w(),data:Object.assign(Object.assign({},n),{mode:"c"})},{app:t,unwrapResult:!0,parseBusinessInfo:!0,swr:r}).catch((e=>{throw B(e,{FUNCTION_NOT_FOUND:"微搭环境异常: 未找到数据源公共云函数",FUNCTIONS_EXECUTE_FAIL:"微搭环境异常: 数据源公共云函数调用失败"})}))}))}function se(e){return u(this,void 0,void 0,(function*(){const t=E(e);return e&&delete t.swr,ie({methodName:"callWedaApi",params:t,swr:oe(null==e?void 0:e.swr)}).then((e=>e.Data))}))}const ae={_:[]};function ce(e){return JSON.parse(JSON.stringify(e))}const ue={wrapperDatasourceMethod:e=>function(t){return Q({name:e.dataSourceName,methodName:e.methodName,params:t})}};function le(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const de="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,fe=()=>de.now(),pe=e=>e===1/0||(e=>e&&e===Math.floor(e)&&e>0&&isFinite(e))(e);class he{constructor({max:e=1/0,ttl:t,updateAgeOnGet:n=!1,checkAgeOnGet:r=!1,noUpdateTTL:o=!1,dispose:i,noDisposeOnSet:s=!1}={}){if(this.expirations=Object.create(null),this.data=new Map,this.expirationMap=new Map,void 0!==t&&!pe(t))throw new TypeError("ttl must be positive integer or Infinity if set");if(!pe(e))throw new TypeError("max must be positive integer or Infinity");if(this.ttl=t,this.max=e,this.updateAgeOnGet=!!n,this.checkAgeOnGet=!!r,this.noUpdateTTL=!!o,this.noDisposeOnSet=!!s,void 0!==i){if("function"!=typeof i)throw new TypeError("dispose must be function if set");this.dispose=i}this.timer=void 0,this.timerExpiration=void 0}setTimer(e,t){if(this.timerExpiration<e)return;this.timer&&clearTimeout(this.timer);const n=setTimeout((()=>{this.timer=void 0,this.timerExpiration=void 0,this.purgeStale();for(const e in this.expirations){this.setTimer(e,e-fe());break}}),t);n.unref&&n.unref(),this.timerExpiration=e,this.timer=n}cancelTimer(){this.timer&&(clearTimeout(this.timer),this.timerExpiration=void 0,this.timer=void 0)}cancelTimers(){return process.emitWarning('TTLCache.cancelTimers has been renamed to TTLCache.cancelTimer (no "s"), and will be removed in the next major version update'),this.cancelTimer()}clear(){const e=this.dispose!==he.prototype.dispose?[...this]:[];this.data.clear(),this.expirationMap.clear(),this.cancelTimer(),this.expirations=Object.create(null);for(const[t,n]of e)this.dispose(n,t,"delete")}setTTL(e,t=this.ttl){const n=this.expirationMap.get(e);if(void 0!==n){const t=this.expirations[n];!t||t.length<=1?delete this.expirations[n]:this.expirations[n]=t.filter((t=>t!==e))}if(t!==1/0){const n=Math.floor(fe()+t);this.expirationMap.set(e,n),this.expirations[n]||(this.expirations[n]=[],this.setTimer(n,t)),this.expirations[n].push(e)}else this.expirationMap.set(e,1/0)}set(e,t,{ttl:n=this.ttl,noUpdateTTL:r=this.noUpdateTTL,noDisposeOnSet:o=this.noDisposeOnSet}={}){if(!pe(n))throw new TypeError("ttl must be positive integer or Infinity");if(this.expirationMap.has(e)){r||this.setTTL(e,n);const i=this.data.get(e);i!==t&&(this.data.set(e,t),o||this.dispose(i,e,"set"))}else this.setTTL(e,n),this.data.set(e,t);for(;this.size>this.max;)this.purgeToCapacity();return this}has(e){return this.data.has(e)}getRemainingTTL(e){const t=this.expirationMap.get(e);return t===1/0?t:void 0!==t?Math.max(0,Math.ceil(t-fe())):0}get(e,{updateAgeOnGet:t=this.updateAgeOnGet,ttl:n=this.ttl,checkAgeOnGet:r=this.checkAgeOnGet}={}){const o=this.data.get(e);if(!r||0!==this.getRemainingTTL(e))return t&&this.setTTL(e,n),o;this.delete(e)}dispose(e,t){}delete(e){const t=this.expirationMap.get(e);if(void 0!==t){const n=this.data.get(e);this.data.delete(e),this.expirationMap.delete(e);const r=this.expirations[t];return r&&(r.length<=1?delete this.expirations[t]:this.expirations[t]=r.filter((t=>t!==e))),this.dispose(n,e,"delete"),0===this.size&&this.cancelTimer(),!0}return!1}purgeToCapacity(){for(const e in this.expirations){const t=this.expirations[e];if(!(this.size-t.length>=this.max)){const e=this.size-this.max,n=[];for(const r of t.splice(0,e))n.push([r,this.data.get(r)]),this.data.delete(r),this.expirationMap.delete(r);for(const[e,t]of n)this.dispose(t,e,"evict");return}{delete this.expirations[e];const n=[];for(const e of t)n.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(const[e,t]of n)this.dispose(t,e,"evict")}}}get size(){return this.data.size}purgeStale(){const e=Math.ceil(fe());for(const t in this.expirations){if("Infinity"===t||t>e)return;const n=[...this.expirations[t]||[]],r=[];delete this.expirations[t];for(const e of n)r.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(const[e,t]of r)this.dispose(t,e,"stale")}0===this.size&&this.cancelTimer()}*entries(){for(const e in this.expirations)for(const t of this.expirations[e])yield[t,this.data.get(t)]}*keys(){for(const e in this.expirations)for(const t of this.expirations[e])yield t}*values(){for(const e in this.expirations)for(const t of this.expirations[e])yield this.data.get(t)}[Symbol.iterator](){return this.entries()}}const ge=new(le(he))({max:1e3,ttl:2e4,checkAgeOnGet:!0});let me=[],ve=[],ye=[];let we=0,Se=0;function Oe(){return u(this,void 0,void 0,(function*(){const e=ve.splice(0);me=me.concat(e);try{const t=m("initTcb"),{app:n}=yield t(),r=(yield P(function(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}(e,40).map((e=>n.getTempFileURL({fileList:e}))))).filter((e=>"fulfilled"===e.status));me=me.filter((t=>!e.includes(t)));const o=r.reduce(((e,t)=>{const n=t.value||{};return n.code&&"SUCCESS"!==n.code?(console.warn("[cloud.getTempFileURL]server response error",n),e):e.concat(n.fileList)}),[]);if(!o.length)return void Ie({},e);const i={},s=[];o.forEach((e=>{var t;(p(t=e,"code")?"SUCCESS"===t.code:p(t,"status")&&!t.status)?i[e.fileID]=e.tempFileURL:(console.warn("[cloud.getTempFileURL]single item failed",e),s.push(e.fileID))})),Ie(i,s)}catch(t){me=me.filter((t=>!e.includes(t))),console.warn("[cloud.getTempFileURL] request failed",t),Ie({},e)}}))}function Ie(e,t){Object.keys(null!=e?e:{}).forEach((t=>{ge.set(t,e[t])})),ye.forEach((e=>{const n=xe(e.fileIds,t);!1!==n&&(e.resolve(n),e.isDone=!0)})),ye=ye.filter((e=>!e.isDone))}function xe(e,t=[]){try{if(Array.isArray(e)){const n={};return e.reduce(((e,n)=>{const r=ge.get(n);if(!r){if(t.includes(n))return e;throw new Error("not found")}return e[n]=r,e}),n)}const n=ge.get(e);if(!n){if(t.includes(e))return;throw new Error("not found")}return n}catch(e){return!1}}const be=Y(!1,(e=>{if("$call"===e)return e=>Q(Object.assign({},e,{parseBusinessInfo:!1}))})),Te={dataSources:Y(!0),callDataSource:Q,callConnector:Q,callModel:Q,IS_WEDA_IDE:!1,version:V,utils:ue,getCloudInstance:X,callGraphql:function(e){return u(this,void 0,void 0,(function*(){try{const t=m("beforeDSRequest");t&&t(e);const n=yield Z({name:w(!0),data:{mode:"graphql",params:e}},{unwrapResult:!0}),r=m("afterDSRequest");return r&&r(e,null,n),n}catch(t){const n=m("afterDSRequest");throw n&&n(e,t),t}}))},callFunction:Z,callWorkflow:function(e){return u(this,void 0,void 0,(function*(){return se(e)}))},callWedaApi:se,callCommonService:ie,getTempFileURL:function(e){const t=function(e){const t=e&&"object"==typeof e&&e.fileList?e.fileList:e;return"string"==typeof t||Array.isArray(t)?t:void 0}(e);if(!t||!t.length)return Promise.resolve();const n=xe(t);return!1!==n?Promise.resolve(n):new Promise(((e,n)=>{!function(e,t,n){ye.push({fileIds:e,resolve:t,reject:n});let r=(Array.isArray(e)?e:[e]).filter((e=>k(e)||D(e)));ve.length&&(r=r.filter((e=>!ve.includes(e))));r.length&&me.length&&(r=r.filter((e=>!me.includes(e))));r.length&&(r=r.filter((e=>!ge.has(e))));if(!r.length)return;ve=ve.concat(r),clearTimeout(Se);const o=Date.now();we=!we||o>we?o+F.tempURLMaxWaitGap:we,Se=setTimeout(Oe,we-o)}(t,e,n)}))},getDataSourceViewId:v,getDataSourceProfile:function(e){const t=m("dataSourceProfiles");if(!t||!t.length)return void console.warn("[weda-cloud-sdk]datasource profile is empty");const n="string"==typeof e?{val:e,key:"name"}:e,r="function"==typeof n?n:e=>e&&e[n.key]===n.val;return t.find(r)},getDataSourceProfileAsync:function(e){return u(this,void 0,void 0,(function*(){const t="string"==typeof e,n=t?{Name:e}:e,r=JSON.stringify(n);if(ae[r])return ce(ae[r]);if(t){const t=ae._.find((t=>t.name===e));if(t)return ce(t)}const o=m("dataSourceProfiles");if((null==o?void 0:o.length)&&t){const t=o.find((t=>t.name===e));if(t)return ce(t)}const{swrMode:i}=n;delete n.swrMode;const s=function(e){const t={};Object.keys(e).reduce(((t,n)=>(t[n.charAt(0).toLowerCase()+n.slice(1)]=e[n],t)),t);const n={schema:{},methods:[]};return Object.keys(n).forEach((e=>{try{t[e]=JSON.parse(t[e])}catch(r){t[e]=n[e]}})),t}(yield se({action:"RuntimeDescribeDataSource",data:n,swr:{swrMode:i}}));return ae[r]=s,ae._.push(s),ce(s)}))},setConfig:W,checkAuth:function(e){return se({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:T};var _e;!function(e){e.local="local",e.none="none",e.session="session"}(_e||(_e={}));var Ae=function(){};function Pe(e,t,n){void 0===n&&(n={});var r=/\?/.test(t),o="";for(var i in n)""===o?!r&&(t+="?"):o+="&",o+=i+"="+encodeURIComponent(n[i]);return/^http(s)?\:\/\//.test(t+=o)?t:""+e+t}function De(){if("undefined"==typeof wx)return!1;if("undefined"==typeof Page)return!1;if(!wx.getSystemInfoSync)return!1;if(!wx.getStorageSync)return!1;if(!wx.setStorageSync)return!1;if(!wx.connectSocket)return!1;if(!wx.request)return!1;try{if(!wx.getSystemInfoSync())return!1;if("qq"===wx.getSystemInfoSync().AppPlatform)return!1}catch(e){return!1}return!0}class ke extends Ae{constructor(e={}){super();const{timeout:t,timeoutMsg:n,restrictedMethods:r}=e;this._timeout=t||0,this._timeoutMsg=n||"请求超时",this._restrictedMethods=r||["get","post","upload","download"]}post(e){const t=this;return new Promise(((n,r)=>{const{url:o,data:i,headers:s}=e,a=wx.request({url:Pe("https:",o),data:i,timeout:t._timeout,method:"POST",header:s,success(e){n(e)},fail(e){r(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("post"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{a.abort()}catch(e){}}}})}))}upload(e){const t=this;return new Promise((n=>{const{url:r,file:o,data:i,headers:s}=e,a=wx.getFileSystemManager(),c=wx.request({url:r,method:e.method,header:Object.assign({"content-type":" "},s),data:a.readFileSync(o),timeout:this._timeout,success(e){const t={statusCode:e.statusCode,data:e.data||{}};200===e.statusCode&&(null==i?void 0:i.success_action_status)&&(t.statusCode=parseInt(i.success_action_status,10)),n(t)},fail(e){n(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("upload"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{c.abort()}catch(e){}}}})}))}download(e){const t=this;return new Promise(((n,r)=>{const{url:o,headers:i}=e,s=wx.downloadFile({url:Pe("https:",o),header:i,timeout:this._timeout,success(e){200===e.statusCode&&e.tempFilePath?n({statusCode:200,tempFilePath:e.tempFilePath}):n(e)},fail(e){r(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("download"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{s.abort()}catch(e){}}}})}))}}class Ee{constructor(e,t={}){const n=wx.connectSocket(Object.assign({url:e},t));return{set onopen(e){n.onOpen(e)},set onmessage(e){n.onMessage(e)},set onclose(e){n.onClose(e)},set onerror(e){n.onError(e)},send:e=>n.send({data:e}),close:(e,t)=>n.close({code:e,reason:t}),get readyState(){return n.readyState},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}}}const Ue={genAdapter:function(){return{root:{},reqClass:ke,wsClass:Ee,localStorage:Ce,primaryStorage:_e.local,getAppSign(){const e=wx.getAccountInfoSync();return"undefined"!=typeof App||"undefined"!=typeof getApp||wx.onAppHide||wx.offAppHide||wx.onAppShow||wx.offAppShow?(null==e?void 0:e.miniProgram)?e.miniProgram.appId:"":(null==e?void 0:e.plugin)?e.plugin.appId:""}}},isMatch:De,runtime:"wx_mp"},Ce={setItem(e,t){wx.setStorageSync(e,t)},getItem:e=>wx.getStorageSync(e),removeItem(e){wx.removeStorageSync(e)},clear(){wx.clearStorageSync()},getKeys(){const{keys:e}=wx.getStorageInfoSync();return e||[]}};const Ne=new class{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return u(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return u(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return u(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}getKeysSync(){return this.localStorage===globalThis.localStorage?Object.keys(this.localStorage):this.localStorage.getKeys()}}({localStorage:De()?Ce:void 0});var $e,je,Me,Le,Re,Fe,We,qe,ze;je=new WeakMap,Me=new WeakMap,Le=new WeakMap,Re=new WeakMap,Fe=new WeakMap,$e=new WeakSet,We=function(e){l(this,Re,"f")===e&&(e.next?d(this,Re,e.next,"f"):e.pre&&d(this,Re,e.pre,"f")),e!==l(this,Le,"f")&&(e.pre&&(e.pre.next=e.next),e.next&&(e.next.pre=e.pre),e.next=l(this,Le,"f"),e.pre=null,l(this,Le,"f")&&(l(this,Le,"f").pre=e),d(this,Le,e,"f"))},qe=function(e){for(;e>0&&l(this,Re,"f");){const{size:t}=l(this,Re,"f").data;l(this,Me,"f").delete(l(this,Re,"f").data.key),l(this,Re,"f").pre?(l(this,Re,"f").pre.next=null,d(this,Re,l(this,Re,"f").pre,"f")):d(this,Re,null,"f"),e-=t,this.calculatedSize-=t}},ze=function(e,t){const n=l(this,Me,"f").get(e,t);return(null==n?void 0:n.node)&&l(this,$e,"m",We).call(this,null==n?void 0:n.node),n};class Ge{constructor(e,t){this.data={key:e,size:t},this.pre=null,this.next=null}}const Ve=/^(?:(\d*);)?(.*)$/;function Be(e){const t=e||"";if("string"==typeof t){const e=t.match(Ve);if(e)return{timestamp:Number(e[1])||0,value:e[2]}}}class Ke extends Map{constructor(){super()}get(e,t={}){const{refreshCache:n=!0}=t,r=super.get(e);let o=Ne.getItemSync(e);if(r&&o){const t=Be(o);return t&&(o=t.value,n&&Ne.setItem(e,`${Date.now()};${o}`)),{node:r,value:o}}}set(e,t,n={}){const{refreshCache:r=!0}=n||{},o=super.set(e,t.node);return r&&Ne.setItemSync(e,`${Date.now()};${t.value}`),o}delete(e){const t=super.delete(e);return Ne.removeItemSync(e),t}}const Je=new class{constructor({map:e=new Map,size:t,sizeCalculation:n=(()=>1),onInit:r}){return $e.add(this),je.set(this,0),Me.set(this,void 0),Le.set(this,void 0),Re.set(this,void 0),Fe.set(this,void 0),this.calculatedSize=0,d(this,je,t||0,"f"),d(this,Me,e,"f"),d(this,Fe,n,"f"),this.calculatedSize=0,d(this,Le,null,"f"),d(this,Re,null,"f"),r&&r(this),this}list(){var e;let t=l(this,Le,"f");const n=[];for(;null==t?void 0:t.data;)n.push({key:t.data.key,value:null===(e=l(this,$e,"m",ze).call(this,t.data.key))||void 0===e?void 0:e.value}),t=t.next;return n}get(e,t){const n=l(this,$e,"m",ze).call(this,e,t);return null==n?void 0:n.value}set(e,t,n){var r;const o=l(this,Fe,"f").call(this,t,e);if(o>l(this,je,"f"))return l(this,Me,"f").delete(e),void(this.calculatedSize-=o);const i=l(this,$e,"m",ze).call(this,e,n),s=null==i?void 0:i.node,a=o-((null===(r=null==s?void 0:s.data)||void 0===r?void 0:r.size)||0);if(s)s.data.size=o,l(this,Me,"f").set(e,{node:s,value:t},n);else{const r=new Ge(e,l(this,Fe,"f").call(this,t,e));null==l(this,Le,"f")&&null===l(this,Re,"f")&&d(this,Re,r,"f"),r.next=l(this,Le,"f"),l(this,Le,"f")&&(l(this,Le,"f").pre=r),d(this,Le,r,"f"),l(this,Me,"f").set(e,{node:r,value:t},n)}l(this,$e,"m",qe).call(this,this.calculatedSize+a-l(this,je,"f")),this.calculatedSize=this.calculatedSize+a}delete(e){const t=l(this,Me,"f").get(e);t&&(l(this,Le,"f")===t.node&&d(this,Le,t.node.next,"f"),l(this,Re,"f")===t.node&&d(this,Re,t.node.pre,"f"),t.node.pre&&(t.node.pre.next=t.node.next),t.node.next&&(t.node.next.pre=t.node.pre),t.node.pre=null,t.node.next=null,this.calculatedSize=this.calculatedSize-t.node.data.size,l(this,Me,"f").delete(e))}}({size:2048e3,sizeCalculation:(e,t)=>`${String(e)}${String(t)}`.length,map:new Ke,onInit:e=>{(Ne.getKeysSync()||[]).filter((e=>e.startsWith("dataset_"))).map((e=>{const t=Ne.getItemSync(e),{value:n,timestamp:r}=Be(t)||{value:t||"",timestamp:0};return{key:e,value:n,timestamp:r}})).sort(((e,t)=>e.timestamp-t.timestamp>=0?1:-1)).forEach((({key:t,value:n})=>{e.set(t,n,{refreshCache:!1})}))}});function He(e,t){if(!e)return;const n=Object.keys(e);if(!n.length)return{};return n.reduce(((n,r)=>{const o=e[r];return n[r]=void 0!==o.initialValue?o.initialValue:o.required?"":void 0,t&&(n[r]=o.sampleValue||n[r]),n}),{})}function Xe(e,t){if(!e)return{};const n=Object.keys(e),r={},o=n.reduce(((n,o)=>{const i=e[o];if("state"!==i.varType)return n;if(i.enableSyncLocal){const e=Qe(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o);e&&(r[e]=!0);try{const e=function(e,t,n,r=!0){const o=Qe(e,t,n);if(o){const e=Je.get(o,{local:!!r});if("string"==typeof e)return JSON.parse(e)}return}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o,!1);n[o]=e}catch(e){console.error("get local state error:",e)}}return void 0===n[o]&&(n[o]=i.initialValue),n}),{});return function(e,t,n={}){const r=Ye(e,t);if(r){(Ne.getKeysSync()||[]).forEach((e=>{!n[e]&&e.startsWith(r)&&Promise.resolve().then((()=>{Je.delete(e)}))}))}}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,r),o}function Qe(e,t,n){const r=Ye(e,t);if(r&&n)return`${r}${n}`}function Ye(e,t){if(e&&t)return`dataset_${e}_${t}_`}const Ze={request:$((e=>{const{url:t}=e,n=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["url"]);"PATCH"===n.method&&(n.headers||(n.headers={}),n.headers["X-HTTP-Method-Override"]="PATCH",n.method="POST"),n.body&&"string"!=typeof n.body&&(n.body=JSON.stringify(n.body,((e,t)=>{if(t&&""!==t)return t})));const r=j(t),o=t.slice(0,t.indexOf(r)),[i,s]=o.match(/:\/\/(.*)$/)||[o,o];n.headers["x-host"]=s;const a=m("envID"),c=A()?t:`${t.replace(s,"tcb-api.tencentcloudapi.com")}${-1!=t.indexOf("?")?`&env=${a}`:`?env=${a}`}`;return new Promise(((e,t)=>{wx.request({url:c,data:n.body,method:n.method,header:n.headers,success(n){"object"==typeof n.data?e(n.data):t(new Error(`resp data error for - ${n.data}`))},fail(e){t(new Error(e.errMsg))}})}))})),storage:new C({localStorage:Ce})};function et(){var e,t;return u(this,void 0,void 0,(function*(){const n=yield M(m(),null===(t=null===(e=m("tcbApiOrigin"))||void 0===e?void 0:e.replace)||void 0===t?void 0:t.call(e,/^https?:\/\//,""));let r={};if(n){const{genOauthAdaper:e=(()=>({}))}=n;r=e({generateOauthClientRequest:$,OauthClientStorgeBase:C})}const o=Object.assign(Object.assign(Object.assign({env:m("envID")},Ze),r),{apiOrigin:m("tcbApiOrigin"),clientId:m("tcbClientId"),custom:{}}),i=s.initializeApp(o);return s.getAuth(i)}))}function tt(){return I(et)}let nt;function rt(){return u(this,void 0,void 0,(function*(){const e=m(),t=e.tcbApiOrigin?e.tcbApiOrigin.replace(/^https?:\/\//,""):"",n=yield M(e,t);let s;if(A()){r.registerAuth(c.default),o.registerFunctions(c.default),i.registerStorage(c.default),c.default.useAdapters(n||Ue),s=c.default.init({timeout:6e4,env:e.envID,clientId:e.tcbClientId||e.envID}),e.tcbApiOrigin&&c.default.registerEndPoint(`//${t}/web`);let a={};if(n){const{genOauthAdaper:e=(()=>({}))}=n;a=e({generateOauthClientRequest:$,OauthClientStorgeBase:C})}return{app:s,auth:s.auth(Object.assign(Object.assign({persistence:"local",anonymousSignInFunc:st},Ze),a))}}return e.resourceAppid?(s=wx.cloud.Cloud({resourceAppid:e.resourceAppid,resourceEnv:e.envID}),yield s.init()):(s=wx.cloud,s.init({env:e.envID})),{app:s,auth:yield tt()}}))}function ot(){return I(rt)}function it(){return u(this,void 0,void 0,(function*(){const{auth:e}=yield ot();let t,n;try{A()?(yield e.getAccessToken(),t=!0):t=yield e.hasLoginState()}catch(e){}try{n=yield e.loginScope()}catch(e){}return{notLogin:!t,isAnonymous:!t||"anonymous"===n,hasLogin:!!t&&"anonymous"!==n}}))}function st(){return u(this,void 0,void 0,(function*(){const{auth:e}=yield ot(),{code:t}=yield wx.login(),{appId:n}=wx.getAccountInfoSync().miniProgram,{provider_token:r}=yield e.grantProviderToken({provider_id:n,provider_code:t});yield e.signInAnonymously({provider_token:r})}))}function at(){return u(this,void 0,void 0,(function*(){if(void 0!==nt)return nt;try{const{auth:e}=yield ot(),t=yield e.getProviderSubType();return nt="NO_AUTH_LOGIN"===(null==t?void 0:t.provider_sub_type),nt}catch(e){return console.log("========> judgePasswordFreeLogin error",e),!1}}))}const ct="lcap-user-session",ut=t.observable({currentUser:null});function lt(e){return u(this,void 0,void 0,(function*(){if(ut.currentUser&&!e.force)return ut.currentUser;const{app:t}=yield ot(),n=yield ie({wx_phone:(null==e?void 0:e.phoneCloudID)?wx.cloud.CloudID(e.phoneCloudID):void 0,methodName:"signIn",params:e},t),r=Object.assign({},n,e,{lastUpdateTime:Date.now()});if(delete r.phoneCloudID,r.userExtend)try{const e=JSON.parse(r.userExtend);r.wxOpenId=r.wxOpenId||(null==e?void 0:e.open_id)||""}catch(e){}if(!r.wxOpenId)try{const{Data:{Data:e}}=yield ie({methodName:"callWedaApi",params:{action:"InvokeComponentWxModule",data:{Method:"GetWxContext"}}},t),n="string"==typeof e?JSON.parse(e):e;r.wxOpenId=(null==n?void 0:n.FROM_OPENID)||(null==n?void 0:n.OPENID)}catch(e){console.error("get wxcontext fail:",e)}return ut.currentUser=r,wx.setStorageSync(ct,r),r}))}var dt={signIn:lt,signOut:function(){return u(this,void 0,void 0,(function*(){const e=yield it(),{auth:t}=yield ot();ut.currentUser=null,e.hasLogin&&t.signOut(),e.isAnonymous||(yield lt({userType:"anonymousUser"}))}))},getUserInfo:function(e=!1){return u(this,void 0,void 0,(function*(){if(!e&&ut.currentUser)return ut.currentUser;const t=wx.getStorageSync(ct);return t?!t.lastUpdateTime||Date.now()-t.lastUpdateTime>2592e5?null:(ut.currentUser=t,t):t}))},setCurrentUserInfo(e={}){for(const t in e)ut.currentUser&&(ut.currentUser[t]=e[t])},get currentUser(){return ut.currentUser?Object.assign({},ut.currentUser):null},getUrlWithOpenidToken:function(e){return u(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login||!e)return"";const{auth:t}=yield X();if(!t)return"";const n=t=>{let[n="",r="",o=""]=e.split(/(?:\?|#)+/);return r.startsWith("/")&&(o=r,r=""),`${n}?${r}${r?"&":""}wx_access_token=${t}${o?"#":""}${o}`};if(A())return new Promise((e=>{wx.login({success:r=>u(this,void 0,void 0,(function*(){const{miniProgram:o}=wx.getAccountInfoSync();try{const{provider_token:i}=yield t.grantProviderToken({provider_code:r.code,provider_id:null==o?void 0:o.appId}),s=n(i);e(s)}catch(t){console.log("=======> [getUrlWithOpenidToken]: grantProviderToken error ",t),e("")}})),fail:t=>{console.log("=======> [getUrlWithOpenidToken]: wx.login fail ",t),e("")}})}));try{const e=yield se({action:"GetMiniProgramUserTicket",data:{Type:"externalUser",OnlyOpenId:!0}}),r=(null==e?void 0:e.token)||e;if(!r)return"";const{provider_token:o}=yield t.grantProviderToken({provider_id:"weda",provider_access_token:`${m("envID")} ${r}`});return n(o)}catch(e){}return""}))},openIdLoginInWxApp:function(){return u(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield X();return!!e&&new Promise((t=>{wx.login({success:n=>u(this,void 0,void 0,(function*(){const{miniProgram:r}=wx.getAccountInfoSync(),o=A()?null==r?void 0:r.appId:"weda";try{const{provider_token:i}=yield e.grantProviderToken({provider_code:n.code,provider_id:o,provider_params:{provider_code_type:"open_id",appid:null==r?void 0:r.appId}}),s=yield e.signInWithProvider({provider_token:i});if(s.code)return console.log("=======> [openIdLoginInWxApp]: signInWithProvider error ",s),void t(!1);yield lt({userType:"externalUser",force:!0}),t(!0)}catch(e){throw console.log("=======> [openIdLoginInWxApp]: error ",e),e}})),fail:e=>{console.log("=======> [openIdLoginInWxApp]: wx.login fail ",e);const t=new Error(null==e?void 0:e.errMsg);throw t.code=null==e?void 0:e.errno,t}})}))}))},unionIdLoginInWxApp:function(){return u(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield X();return!!e&&new Promise((t=>{wx.login({success:n=>u(this,void 0,void 0,(function*(){const{miniProgram:r}=wx.getAccountInfoSync(),o=A()?null==r?void 0:r.appId:"weda";try{const{provider_token:i}=yield e.grantProviderToken({provider_code:n.code,provider_id:o,provider_params:{provider_code_type:"union_id",appid:null==r?void 0:r.appId}}),s=yield e.signInWithProvider({provider_id:o,provider_token:i});if(s.code)return console.log("=======> [unionIdLoginInWxApp]: signInWithProvider error ",s),void t(!1);yield lt({userType:"externalUser",force:!0}),t(!0)}catch(e){throw console.log("=======> [unionIdLoginInWxApp]: error ",e),e}})),fail:e=>{console.log("=======> [unionIdLoginInWxApp]: wx.login fail ",e);const t=new Error(null==e?void 0:e.errMsg);throw t.code=null==e?void 0:e.errno,t}})}))}))},modifyCurrentUser:function({nickName:e="",userName:t="",avatarUrl:n="",description:r=""}={}){return u(this,void 0,void 0,(function*(){const{userType:o,wedaId:i,nickName:s,avatarUrl:a,userName:c,description:u}=ut.currentUser;if("anonymousUser"===o||!i)return{};try{return yield se({action:"ModifyUserBasicInfo",data:{user_id:i,nickname:e||s||"",username:t||c||"",description:r||u||"",avatar_url:n||a||""}}),yield lt({userType:o,force:!0})}catch(e){console.log("=======> [modifyCurrentUser]: error ",e)}return{}}))},judgePasswordFreeLogin:at};const ft=Object.assign(Te,dt);function pt(){return u(this,void 0,void 0,(function*(){const{app:e,auth:t}=yield ot(),n=yield it();let r=n.isAnonymous||n.notLogin?"anonymousUser":"externalUser",o="";if(n.notLogin){if(yield at()){const{miniProgram:e}=wx.getAccountInfoSync();r="externalUser",o=A()?null==e?void 0:e.appId:"weda"}else A()&&(yield st())}return yield dt.signIn({userType:r,force:!0,providerId:o}).catch((e=>{console.warn("[weda-cloud-sdk] failed to sign-in/getUserInfo weda backend",e)})),e.auth&&(e._auth=e.auth),e.auth=t,{app:e,auth:t}}))}function ht(){return u(this,void 0,void 0,(function*(){return I(pt)}))}Object.defineProperty(ft,"currentUser",{get:()=>dt.currentUser}),y({initTcb:ht}),e.CLOUD_API=Te,e.CLOUD_SDK=ft,e.DATASET_CONTEXT=h,e.DS_SDK=be,e.EXTRA_API=R,e.OauthClientStorgeBase=C,e.PromiseAllSettled=P,e.TCBError=f,e._generatePrivatelinkAdapter=M,e.callDataSource=Q,e.createDataset=function(e,n,r){y({currentPageId:e});const o=(m("datasetProfiles")||{})[e],i=t.observable({state:{$status:{}},params:{}});if(h[e]=i,!o)return i;const s=He(o.params,n),a=Xe(o.state,{appId:null==r?void 0:r.appId,datasetProfileKey:e});return Object.assign(i.params,s),Object.assign(i.state,a),i},e.createParamsVar=He,e.createSetDefaultParams=function(e){return t=>{T(e,t)}},e.createStateDataSourceVar=function(e,t){var n,r;return u(this,void 0,void 0,(function*(){const o=null===(n=h[e])||void 0===n?void 0:n.state,i=m("datasetProfiles")||{},s=null===(r=i[e])||void 0===r?void 0:r.state;if(!o||!s)return;Object.keys(s).forEach((n=>u(this,void 0,void 0,(function*(){const r=s[n];if("datasource"===r.varType){if(!r.initMethod||!r.initMethod.name)return o[n]={},void(o.$status[n]={status:"idle"});try{o.$status[r.name]={status:"loading"};const{initMethod:n}=r,i=yield Te.callDataSource({name:r.dataSourceName,methodName:n.name,params:t(n.params,n),options:{showLoading:!0}});L(`${e}.${r.name}`,i)}catch(t){console.error(`[weda-cloud-sdk] 初始化变量 ${e}.${r.name} 失败`,t),L(`${e}.${r.name}`,t)}}}))))}))},e.createStaticStateVar=Xe,e.deepClone=E,e.execOnce=I,e.generateOauthClientRequest=$,e.generateParamsParser=function(e){return t=>{if(!t)return t;const n={};return Object.keys(t).forEach((r=>{n[r]=t[r](e.app,e.$page,e.$w)})),n}},e.getAccessToken=function(){return u(this,void 0,void 0,(function*(){if(yield at())return{accessToken:""};if(A()){const{auth:e}=yield ot();return e.getAccessToken()}const e=yield tt();return{accessToken:yield e.credentialsClient.getAccessToken()}}))},e.getCommonCloudFnName=w,e.getConfig=m,e.getDataSourceViewId=v,e.getDatasetProfiles=U,e.getDatasourceCloudFnName=function(e){return g.useLegacyDatasource?`lcap-${e.id}-${e.name}${g.isProd?"":"-preview"}`:"lowcode-datasource"+(g.isProd?"":"-preview")},e.getDefaultParams=_,e.getTcbInstance=ot,e.getUrlPath=j,e.hasOwn=p,e.initTcb=ht,e.isObject=k,e.isSameArray=S,e.isString=D,e.pick=x,e.setConfig=y,e.setDatasetProfiles=function(e){y({datasetProfiles:Object.assign(m("datasetProfiles")||{},e)})},e.setDefaultParams=T,e.setLocalDatasetState=function(e,t,n,r){var o,i;const s=Qe(e,t,n);if(s){const a=(null===(o=U(t))||void 0===o?void 0:o.state)||{};if(void 0===r)Je.delete(s);else{const t=JSON.stringify(r);let o;try{o=JSON.stringify(null===(i=null==a?void 0:a[n])||void 0===i?void 0:i.initialValue)}catch(e){}if(t===o)Je.delete(s);else try{Je.set(s,t)}catch(t){if(/exceed storage max size/.test(null==t?void 0:t.message)||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name){(Ne.getKeysSync()||[]).forEach((t=>{t.startsWith("dataset_")&&!t.startsWith(`dataset_${e}`)&&Promise.resolve().then((()=>{Je.delete(s)}))}))}else Je.delete(s);throw t}}}},e.useTcbApi=A,Object.defineProperty(e,"__esModule",{value:!0})}));
